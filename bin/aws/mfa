#!/bin/bash

# exit on failures
set -e
set -o pipefail

. "${APP_ROOT}/lib/colors.sh"

DALMATIAN_MFA_CREDENTIALS_FILE="$HOME/.config/dalmatian/mfa_credentials.json"

usage() {
  echo "Usage: dalmatian aws $(basename "$0") -m <mfa_code> [-e]" 1>&2
  echo "  -h                  Get help for this command"
  echo "  -m <mfa_code>       Specify the MFA Code"
  echo
  echo "Options:"
  echo "  -e                  Export to stdout instead of writing the MFA"
  echo "                      credentials to $DALMATIAN_MFA_CREDENTIALS_FILE"
  exit 1
}

# if there are no arguments passed exit with usage
if [ $# -eq 0 ]
then
  fatal "Please specify the MFA Code"
  echo
  usage
  exit 0
fi

EXPORT_TO_STDOUT=0

while getopts "m:eh" opt; do
  case $opt in
    m)
      MFA_CODE=$OPTARG
      ;;
    e)
      EXPORT_TO_STDOUT=1
      ;;
    h)
      usage
      exit;;
    *)
      usage
      exit;;
  esac
done

if [[ -z "$MFA_CODE" ]]
then
  fatal "Please specify a 6 digit MFA Code"
  echo
  usage
  exit 0
fi

USERNAME=$(aws sts get-caller-identity | jq -r .Arn | rev | cut -f1 -d'/' | rev)
MFA_DEVICE=$(aws iam list-mfa-devices --user-name "$USERNAME" | jq -r .MFADevices[0].SerialNumber)
SESSION_TOKEN_JSON=$(aws sts get-session-token --serial-number "$MFA_DEVICE" --token-code "$MFA_CODE")
AWS_ACCESS_KEY_ID=$(echo "$SESSION_TOKEN_JSON" | jq -r .Credentials.AccessKeyId)
AWS_SECRET_ACCESS_KEY=$(echo "$SESSION_TOKEN_JSON" | jq -r .Credentials.SecretAccessKey)
AWS_SESSION_TOKEN=$(echo "$SESSION_TOKEN_JSON" | jq -r .Credentials.SessionToken)
AWS_SESSION_EXPIRATION=$(echo "$SESSION_TOKEN_JSON" | jq -r .Credentials.Expiration | awk -F':' -v OFS=':' '{ print $1, $2, $3$4 }')

if [ "$EXPORT_TO_STDOUT" == 1 ];
then
  success "export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID"
  success "export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY"
  success "export AWS_SESSION_TOKEN=$AWS_SESSION_TOKEN"
else
  MFA_CREDENTIALS_JSON_STRING=$(
    jq -n \
    --arg aws_access_key_id "$AWS_ACCESS_KEY_ID" \
    --arg aws_secret_access_key "$AWS_SECRET_ACCESS_KEY" \
    --arg aws_session_token "$AWS_SESSION_TOKEN" \
    --arg aws_session_expiration "$AWS_SESSION_EXPIRATION" \
    '{
      aws_access_key_id: $aws_access_key_id,
      aws_secret_access_key: $aws_secret_access_key,
      aws_session_token: $aws_session_token,
      aws_session_expiration: $aws_session_expiration
    }'
  )

  echo "$MFA_CREDENTIALS_JSON_STRING" > "$DALMATIAN_MFA_CREDENTIALS_FILE"
  chmod 600 "$DALMATIAN_MFA_CREDENTIALS_FILE"
  success "Stored MFA credentials in $DALMATIAN_MFA_CREDENTIALS_FILE"
fi
