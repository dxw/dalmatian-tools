#!/bin/bash

# exit on failures
set -e
set -o pipefail

usage() {
  echo "Usage: $(basename "$0") [OPTIONS]" 1>&2
  echo "  -f <force_update>      - Force update (Runs through the upate process even if dalmatian-tools is on the latest version)"
  echo "  -h                     - help"
  exit 1
}

FORCE_UPDATE=0
while getopts "fh" opt; do
  case $opt in
    f)
      FORCE_UPDATE=1
      ;;
    h)
      usage
      ;;
    *)
      usage
      ;;
  esac
done

CONFIG_UPDATE_CHECK_JSON_FILE="$CONFIG_DIR/update-check.json"
if [ ! -f "$CONFIG_UPDATE_CHECK_JSON_FILE" ]
then
  UPDATE_CHECK_JSON=$(
    jq -n \
      --arg complete_status "1" \
      '{
        complete_status: $complete_status
      }'
  )
  echo "$UPDATE_CHECK_JSON" > "$CONFIG_UPDATE_CHECK_JSON_FILE"
fi

UPDATE_CHECK_LAST_COMPLETE_STATUS=$(jq -r '.complete_status' < "$CONFIG_UPDATE_CHECK_JSON_FILE")

log_info -l "Checking for newer version ..." -q "$QUIET_MODE"
RELEASE_JSON=$(curl -s "$GIT_DALMATIAN_TOOLS_API_REPOS_LATEST_RELEASE_URL" | jq -r)

GITHUB_MESSAGE=$(echo "$RELEASE_JSON" | jq -r '.message')

if [ "$GITHUB_MESSAGE" != "null" ]
then
  err "Github: $GITHUB_MESSAGE"
  log_info -l "This error may have occured, because the dxw/dalmatian-tools repo is private."
  log_info -l "To use a GitHub token, manually add \`dalmatian_update_github_token\` to the"
  log_info -l "setup file: $CONFIG_SETUP_JSON_FILE"
  log_info -l "Note: Redact your GitHub token before sharing this setup file with anyone"
  log_info -l "This is only a temporary measure whilst the repo is private"
  exit 1
fi

LATEST_REMOTE_TAG=$(echo "$RELEASE_JSON" | jq -r '.name')
CURRENT_LOCAL_TAG=$(git -C "$APP_ROOT" describe --tags)
LOCAL_CHANGES=$(git -C "$APP_ROOT" status --porcelain)
if [[
  "$LATEST_REMOTE_TAG" != "$CURRENT_LOCAL_TAG" ||
  "$FORCE_UPDATE" == 1 ||
  "$UPDATE_CHECK_LAST_COMPLETE_STATUS" == 0
]]
then
  if [ "$UPDATE_CHECK_LAST_COMPLETE_STATUS" == 0 ]
  then
    err "The last update did not complete successfully. Attempting another update ..."
  fi
  UPDATE_CHECK_JSON=$(
    jq -r \
      --arg complete_status "0" \
      < "$CONFIG_UPDATE_CHECK_JSON_FILE"
  )
  echo "$UPDATE_CHECK_JSON" > "$CONFIG_UPDATE_CHECK_JSON_FILE"
  if [ -n "$LOCAL_CHANGES" ]
  then
    err "There may be a newer version of $GIT_DALMATIAN_TOOLS_OWNER/$GIT_DALMATIAN_TOOLS_REPO ($CURRENT_LOCAL_TAG -> $LATEST_REMOTE_TAG) but cant update!"
    err "This is because you have local changes in $APP_ROOT"
    if ! yes_no "Do you want to continue without updating? (Y/N)" "N" 
    then
      exit 1
    fi
    exit 0
  fi
  log_info -l "Updating ..." -q "$QUIET_MODE"
  log_info -l "Updating dalmatian requires elevated permissions"
  log_info -l "Attempting sudo ..."
  sudo -v
  log_info -l "Elevated permissions are available, continuing ..."
  git -C "$APP_ROOT" checkout main
  git -C "$APP_ROOT" pull
  git -C "$APP_ROOT" -c advice.detachedHead=false checkout "$LATEST_REMOTE_TAG"
  log_info -l "Updating brew packages ..." -q "$QUIET_MODE"
  brew bundle --file="$APP_ROOT/Brewfile"
  "$APP_ROOT/bin/dalmatian" terraform-dependencies clone -I
  "$APP_ROOT/bin/dalmatian" terraform-dependencies get-tfvars
  UPDATE_CHECK_JSON=$(
    jq -r \
      '.complete_status |= "1"' \
      < "$CONFIG_UPDATE_CHECK_JSON_FILE"
  )
  echo "$UPDATE_CHECK_JSON" > "$CONFIG_UPDATE_CHECK_JSON_FILE"
  log_info -l "Update complete üëç" -q "$QUIET_MODE"
else
  log_info -l "You are on the latest version ($LATEST_REMOTE_TAG) üëç" -q "$QUIET_MODE"
fi
