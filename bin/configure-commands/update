#!/bin/bash

# exit on failures
set -e
set -o pipefail

usage() {
  echo "Usage: $(basename "$0") [OPTIONS]" 1>&2
  echo "  -g <git_auth_token>    - Git Auth token (Optional - only required if dalmatian tools repo is private)"
  echo "  -h                     - help"
  exit 1
}

log_info -l "Updating dalmatian requires elevated permissions"
log_info -l "Attempting sudo ..."
sudo -v
log_info -l "Elevated permissions are available, continuing ..."

GIT_AUTH_TOKEN="$(jq -r '.dalmatian_update_github_token' < "$CONFIG_SETUP_JSON_FILE")"

while getopts "g:h" opt; do
  case $opt in
    g)
      GIT_AUTH_TOKEN=$OPTARG
      ;;
    h)
      usage
      ;;
    *)
      usage
      ;;
  esac
done

log_info -l "Checking for newer version ..." -q "$QUIET_MODE"
if [ -n "$GIT_AUTH_TOKEN" ]
then
  RELEASE_JSON=$(curl -s -H "Authorization: Bearer $GIT_AUTH_TOKEN" "$GIT_DALMATIAN_TOOLS_API_REPOS_LATEST_RELEASE_URL" | jq -r)
else
  RELEASE_JSON=$(curl -s "$GIT_DALMATIAN_TOOLS_API_REPOS_LATEST_RELEASE_URL" | jq -r)
fi

GITHUB_MESSAGE=$(echo "$RELEASE_JSON" | jq -r '.message')

if [ "$GITHUB_MESSAGE" != "null" ]
then
  err "Github: $GITHUB_MESSAGE"
  log_info -l "This error may have occured, because the dxw/dalmatian-tools repo is private."
  log_info -l "To use a GitHub token, manually add \`dalmatian_update_github_token\` to the"
  log_info -l "setup file: $CONFIG_SETUP_JSON_FILE"
  log_info -l "Note: Redact your GitHub token before sharing this setup file with anyone"
  log_info -l "This is only a temporary measure whilst the repo is private"
  exit 1
fi

LATEST_REMOTE_TAG=$(echo "$RELEASE_JSON" | jq -r '.name')
CURRENT_LOCAL_TAG=$(git -C "$APP_ROOT" describe --tags)
LOCAL_CHANGES=$(git -C "$APP_ROOT" status --porcelain)
if [ "$LATEST_REMOTE_TAG" != "$CURRENT_LOCAL_TAG" ]
then
  if [ -n "$LOCAL_CHANGES" ]
  then
    err "There may be a newer version of $GIT_DALMATIAN_TOOLS_OWNER/$GIT_DALMATIAN_TOOLS_REPO ($CURRENT_LOCAL_TAG -> $LATEST_REMOTE_TAG) but cant update!"
    err "This is because you have local changes in $APP_ROOT"
    if ! yes_no "Do you want to continue without updating? (Y/N)" "N" 
    then
      exit 1
    fi
    exit 0
  fi
  log_info -l "Updating ..." -q "$QUIET_MODE"
  git -C "$APP_ROOT" checkout main
  git -C "$APP_ROOT" pull
  git -C "$APP_ROOT" checkout "$LATEST_REMOTE_TAG"
  log_info -l "Updating brew packages ..." -q "$QUIET_MODE"
  brew bundle --file="$APP_ROOT/Brewfile"
  "$APP_ROOT/bin/dalmatian" terraform-dependencies clone -I
  "$APP_ROOT/bin/dalmatian" terraform-dependencies get-tfvars
else
  log_info -l "You are on the latest version ($LATEST_REMOTE_TAG) üëç" -q "$QUIET_MODE"
fi
