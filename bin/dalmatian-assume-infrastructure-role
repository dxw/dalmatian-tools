#!/bin/bash

# exit on failures
set -e
set -o pipefail

usage() {
  echo "Usage: $(basename "$0") [OPTIONS]" 1>&2
  echo "  -h                       - help"
  echo "  -i <infrastructure_name> - Infrastructure Name (required)"
  echo "  -p <profile>             - AWS Profile         (default: AWS_PROFILE)"
  exit 1
}

# if there are no arguments passed exit with usage
if [ $# -lt 1 ];
then
 usage
fi

SCRIPT_PATH="$( cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"

AWS_PROFILE=${AWS_PROFILE:-default}

while getopts "i:p:h" opt; do
  case $opt in
    i)
      INFRASTRUCTURE_NAME=$OPTARG
      ;;
    p)
      AWS_PROFILE=$OPTARG
      ;;
    h)
      usage
      ;;
    *)
      usage
      ;;
  esac
done

if [ -z "$INFRASTRUCTURE_NAME" ]; then
  usage
fi

"$SCRIPT_PATH/dalmatian-refresh-config" -p "$AWS_PROFILE" > /dev/null

INFRASTRUCTURE_ACCOUNT_ID=$(yq r "$SCRIPT_PATH/tmp/dalmatian-config/dalmatian.yml" "infrastructures.$INFRASTRUCTURE_NAME.account_id")

if [ -z "$INFRASTRUCTURE_ACCOUNT_ID" ]
then
  echo "==> Error: Infrastructure '$INFRASTRUCTURE_NAME' not found in dalmatian-config," 1>&2
  echo "           or it does not contain an 'account_id'" 1>&2
  exit 1
fi

CREDENTIALS=$(aws sts assume-role --role-arn arn:aws:iam::"$INFRASTRUCTURE_ACCOUNT_ID":role/dalmatian-admin --role-session-name dalmatian-tools --profile "$AWS_PROFILE")

ACCESS_KEY_ID=$(echo "$CREDENTIALS" | jq -r .Credentials.AccessKeyId)
SECRET_ACCESS_KEY=$(echo "$CREDENTIALS" | jq -r .Credentials.SecretAccessKey)
SESSION_TOKEN=$(echo "$CREDENTIALS" | jq -r .Credentials.SessionToken)

echo "export AWS_ACCESS_KEY_ID=$ACCESS_KEY_ID"
echo "export AWS_SECRET_ACCESS_KEY=$SECRET_ACCESS_KEY"
echo "export AWS_SESSION_TOKEN=$SESSION_TOKEN"
