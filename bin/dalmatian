#!/bin/bash

# exit on failures
set -e
set -o pipefail

usage() {
  echo "Usage: $(basename "$0")" 1>&2
  echo "  SUBCOMMAND COMMAND     - dalmatian command to run"
  echo "  SUBCOMMAND COMMAND -h  - show command help"
  echo "    Or:"
  echo "  -h                     - help"
  echo "  -l                     - list comands"
  exit 1
}

# if there are no arguments passed exit with usage
if [ $# -lt 1 ];
then
 usage
fi

APP_ROOT="$( cd "$(dirname "${BASH_SOURCE[0]}")"/.. && pwd -P)"
export APP_ROOT

if [ "${1:0:1}" == "-" ]
then
  while getopts "lh" opt; do
    case $opt in
      l)
        LIST_COMMANDS=1
        ;;
      h)
        usage
        ;;
      *)
        usage
        ;;
    esac
  done

  if [ -n "$LIST_COMMANDS" ]
  then
    echo "Available commands:"
    echo ""

    DIRS=()
    while IFS=  read -r -d $'\0'; do
      DIRS+=("$REPLY")
    done < <(find "$APP_ROOT/bin" -maxdepth 1 -type d -print0)

    SUBCOMMANDS=()
    for d in "${DIRS[@]}"
    do
      SUBCOMMANDS+=("$(basename "$d")")
    done
    IFS=" " read -r -a SUBCOMMANDS <<< "$(sort <<<"${SUBCOMMANDS[*]}")"

    # list configure-commands
    FILES=()
    while IFS=  read -r -d $'\0'; do
      FILES+=("$REPLY")
    done < <(find "$APP_ROOT/bin/configure-commands" -maxdepth 1 -type f -print0)

    CONFIGURE_COMMANDS=()
    for f in "${FILES[@]}"
    do
      CONFIGURE_COMMANDS+=("$(basename "$f")")
    done
    IFS=" " read -r -a CONFIGURE_COMMANDS <<< "$(sort <<<"${CONFIGURE_COMMANDS[*]}")"

    for CONFIGURE_COMMAND in "${CONFIGURE_COMMANDS[@]}"
    do
      echo "  $CONFIGURE_COMMAND"
    done
    echo ""

    for SUBCOMMAND in "${SUBCOMMANDS[@]}"
    do
      if [[ "$SUBCOMMAND" != "bin" && "$SUBCOMMAND" != "tmp" && "$SUBCOMMAND" != "configure-commands" ]]
      then
        echo "  $SUBCOMMAND"
        FILES=()
        while IFS=  read -r -d $'\0'; do
          FILES+=("$REPLY")
        done < <(find "$APP_ROOT/bin/$SUBCOMMAND" -maxdepth 1 -type f -print0)

        COMMANDS=()
        for f in "${FILES[@]}"
        do
          COMMANDS+=("$(basename "$f")")
        done
        IFS=" " read -r -a COMMANDS <<< "$(sort <<<"${COMMANDS[*]}")"

        for COMMAND in "${COMMANDS[@]}"
        do
          echo "    $COMMAND"
        done
        echo ""
      fi
    done
  fi
  exit 0
fi

SUBCOMMAND="$1"
COMMAND="$2"
COMMAND_ARGS=( "${@:3}" )

if [[ -z "$SUBCOMMAND" && -z "$COMMAND" ]]
then
  usage
fi

if [[ -z "$COMMAND" ]]
then
  "$APP_ROOT/bin/configure-commands/$SUBCOMMAND"
  exit 0
fi

DALMATIAN_CONFIG_STORE="$HOME/.config/dalmatian"
DALMATIAN_CONFIG_FILE="$DALMATIAN_CONFIG_STORE/config.json"
DALMATIAN_CREDENTIALS_FILE="$DALMATIAN_CONFIG_STORE/credentials.json.enc"
DALMATIAN_MFA_CREDENTIALS_FILE="$DALMATIAN_CONFIG_STORE/mfa_credentials.json"
DALMATIAN_ASSUME_MAIN_ROLE_CREDENTIALS_FILE="$DALMATIAN_CONFIG_STORE/assume_role_credentials.json"
MFA_CONFIGURED=0
ASSUME_MAIN_ROLE_CONFIGURED=0

if [ ! -f "$DALMATIAN_CONFIG_FILE" ]
then
  echo "Error: You are not logged into Dalmatian"
  echo "       Run \`dalmatian login\` to continue"
  exit 1
fi

AWS_DEFAULT_REGION="eu-west-2" # London
export AWS_DEFAULT_REGION

DALMATIAN_CONFIG_JSON_STRING=$(cat "$DALMATIAN_CONFIG_FILE")
ACCOUNT_ID=$(echo "$DALMATIAN_CONFIG_JSON_STRING" | jq -r '.account_id')
DALMATIAN_ROLE=$(echo "$DALMATIAN_CONFIG_JSON_STRING" | jq -r '.dalmatian_role')

# If MFA credentials exist, check if they have expired
if [ -f "$DALMATIAN_MFA_CREDENTIALS_FILE" ]
then
  DALMATIAN_MFA_CREDENTIALS_JSON_STRING=$(cat "$DALMATIAN_MFA_CREDENTIALS_FILE")
  DALMATIAN_MFA_EXPIRATION=$(echo "$DALMATIAN_MFA_CREDENTIALS_JSON_STRING" | jq -r '.aws_session_expiration')
  if [ "${DALMATIAN_MFA_EXPIRATION: -1}" == "Z" ]
  then
    DALMATIAN_MFA_EXPIRATION_SECONDS=$(date -j -f "%F T %T Z" "$DALMATIAN_MFA_EXPIRATION" +"%s")
  else
    DALMATIAN_MFA_EXPIRATION_SECONDS=$(date -j -f "%F T %T %z" "$DALMATIAN_MFA_EXPIRATION" +"%s")
  fi
  EPOCH=$(date +%s)
  if [ "$DALMATIAN_MFA_EXPIRATION_SECONDS" -lt "$EPOCH" ]
  then
    echo "==> MFA credentials expired, requesting new credentials ..."
  else
    MFA_CONFIGURED=1
  fi
fi

if [[ "$SUBCOMMAND" == "aws" && "$COMMAND" == "mfa" ]]
then
  RUN_AWS_MFA=1
fi

# Update MFA credentials if needed, or if the dalmatian aws mfa command is ran
if [[ -n "$RUN_AWS_MFA" || "$MFA_CONFIGURED" == 0 ]]
then
  DALMATIAN_CREDENTIALS_JSON_STRING=$(
    gpg --decrypt \
      --quiet \
      < "$DALMATIAN_CREDENTIALS_FILE"
  )

  AWS_ACCESS_KEY_ID=$(echo "$DALMATIAN_CREDENTIALS_JSON_STRING" | jq -r '.aws_access_key_id')
  AWS_SECRET_ACCESS_KEY=$(echo "$DALMATIAN_CREDENTIALS_JSON_STRING" | jq -r '.aws_secret_access_key')
  AWS_MFA_SECRET=$(echo "$DALMATIAN_CREDENTIALS_JSON_STRING" | jq -r '.aws_mfa_secret')
  export AWS_ACCESS_KEY_ID
  export AWS_SECRET_ACCESS_KEY
  oathtool --base32 --totp "$AWS_MFA_SECRET"
  MFA_CODE="$(oathtool --base32 --totp "$AWS_MFA_SECRET")"
  echo "$MFA_CODE"
  "$APP_ROOT/bin/aws/mfa" -m "$MFA_CODE"
  if [ -n "$RUN_AWS_MFA" ]
  then
    exit 0
  fi
fi

# export MFA credentials
DALMATIAN_MFA_CREDENTIALS_JSON_STRING=$(cat "$DALMATIAN_MFA_CREDENTIALS_FILE")
AWS_ACCESS_KEY_ID=$(echo "$DALMATIAN_MFA_CREDENTIALS_JSON_STRING" | jq -r '.aws_access_key_id')
AWS_SECRET_ACCESS_KEY=$(echo "$DALMATIAN_MFA_CREDENTIALS_JSON_STRING" | jq -r '.aws_secret_access_key')
AWS_SESSION_TOKEN=$(echo "$DALMATIAN_MFA_CREDENTIALS_JSON_STRING" | jq -r '.aws_session_token')
export AWS_ACCESS_KEY_ID
export AWS_SECRET_ACCESS_KEY
export AWS_SESSION_TOKEN

# Check if the assume role credentials have expired
if [ -f "$DALMATIAN_ASSUME_MAIN_ROLE_CREDENTIALS_FILE" ]
then
  DALMATIAN_ASSUME_MAIN_ROLE_CREDENTIALS_JSON_STRING=$(cat "$DALMATIAN_ASSUME_MAIN_ROLE_CREDENTIALS_FILE")
  DALMATIAN_ASSUME_MAIN_ROLE_CREDENTIALS_EXPIRATION=$(echo "$DALMATIAN_ASSUME_MAIN_ROLE_CREDENTIALS_JSON_STRING" | jq -r '.aws_session_expiration')
  DALMATIAN_ASSUME_MAIN_ROLE_CREDENTIALS_EXPIRATION_SECONDS=$(date -j -f "%F T %T %z" "$DALMATIAN_ASSUME_MAIN_ROLE_CREDENTIALS_EXPIRATION" +"%s")
  EPOCH=$(date +%s)
  if [ "$DALMATIAN_ASSUME_MAIN_ROLE_CREDENTIALS_EXPIRATION_SECONDS" -lt "$EPOCH" ]
  then
    echo "==> Assume role credentials expired ..."
  else
    ASSUME_MAIN_ROLE_CONFIGURED=1
  fi
fi

# Update assume role credentials if needed
if [ "$ASSUME_MAIN_ROLE_CONFIGURED" == "0" ]
then
  echo "==> Requesting Assume Role credentials ..."
  ASSUME_ROLE_RESULT=$(
    aws sts assume-role \
    --role-arn "arn:aws:iam::$ACCOUNT_ID:role/$DALMATIAN_ROLE" \
    --role-session-name dalmatian-tools \
    --external-id dalmatian-tools
  )
  AWS_ACCESS_KEY_ID=$(echo "$ASSUME_ROLE_RESULT" | jq -r '.Credentials.AccessKeyId')
  AWS_SECRET_ACCESS_KEY=$(echo "$ASSUME_ROLE_RESULT" | jq -r '.Credentials.SecretAccessKey')
  AWS_SESSION_TOKEN=$(echo "$ASSUME_ROLE_RESULT" | jq -r '.Credentials.SessionToken')
  AWS_SESSION_EXPIRATION=$(echo "$ASSUME_ROLE_RESULT" | jq -r '.Credentials.Expiration' | awk -F':' -v OFS=':' '{ print $1, $2, $3$4 }')
  DALMATIAN_ASSUME_MAIN_ROLE_CREDENTIALS_JSON_STRING=$(
    jq -n \
    --arg aws_access_key_id "$AWS_ACCESS_KEY_ID" \
    --arg aws_secret_access_key "$AWS_SECRET_ACCESS_KEY" \
    --arg aws_session_token "$AWS_SESSION_TOKEN" \
    --arg aws_session_expiration "$AWS_SESSION_EXPIRATION" \
    '{
      aws_access_key_id: $aws_access_key_id,
      aws_secret_access_key: $aws_secret_access_key,
      aws_session_token: $aws_session_token,
      aws_session_expiration: $aws_session_expiration
    }'
  )

  echo "$DALMATIAN_ASSUME_MAIN_ROLE_CREDENTIALS_JSON_STRING" > "$DALMATIAN_ASSUME_MAIN_ROLE_CREDENTIALS_FILE"
fi

# export assume role credentials
DALMATIAN_MFA_CREDENTIALS_JSON_STRING=$(cat "$DALMATIAN_ASSUME_MAIN_ROLE_CREDENTIALS_FILE")
AWS_ACCESS_KEY_ID=$(echo "$DALMATIAN_MFA_CREDENTIALS_JSON_STRING" | jq -r '.aws_access_key_id')
AWS_SECRET_ACCESS_KEY=$(echo "$DALMATIAN_MFA_CREDENTIALS_JSON_STRING" | jq -r '.aws_secret_access_key')
AWS_SESSION_TOKEN=$(echo "$DALMATIAN_MFA_CREDENTIALS_JSON_STRING" | jq -r '.aws_session_token')
export AWS_ACCESS_KEY_ID
export AWS_SECRET_ACCESS_KEY
export AWS_SESSION_TOKEN

i=1
for a in "${COMMAND_ARGS[@]}"
do
  if [ "$a" == "-i" ]
  then
    INFRASTRUCTURE_NAME="${COMMAND_ARGS[$i]}"
  fi
  i=$(( i + 1 ))
done

# Assume Role for infrastructure if set
if [ -n "$INFRASTRUCTURE_NAME" ]
then
  # shellcheck source=bin/aws/assume-infrastructure-role
  . "$APP_ROOT/bin/aws/assume-infrastructure-role" -i "$INFRASTRUCTURE_NAME"
fi

# Run specified command with args
"$APP_ROOT/bin/$SUBCOMMAND/$COMMAND" "${COMMAND_ARGS[@]}"
